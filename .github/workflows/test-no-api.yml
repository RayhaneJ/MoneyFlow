name: Test AI Workflow (No API calls, Production Safe)

on:
  workflow_dispatch:
    inputs:
      task:
        description: 'Test task description'
        required: true
        default: 'Add a simple feature'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  test-ai-workflow:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout full repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # clone complet pour Ã©viter "No commits between master and branch"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Test - Create mock AI response
        run: |
          echo "ğŸ§ª Creating MOCK AI response (no API call)"
          cat > ai_output.json << 'EOF'
          {
            "task": "${{ inputs.task }}",
            "files_created": ["app/src/main/java/com/moneyflow/tracker/test/TestFile.kt"],
            "files_modified": [],
            "pr_title": "Test: ${{ inputs.task }}",
            "pr_description": "This is a TEST PR generated without calling the AI API.\n\n- No tokens consumed\n- No API costs\n- Just testing the workflow",
            "breaking_changes": false,
            "requires_migration": false
          }
          EOF
          echo "âœ… Mock response created"
          cat ai_output.json

      - name: Test - Create mock code file
        run: |
          echo "ğŸ§ª Creating MOCK Kotlin file"
          mkdir -p app/src/main/java/com/moneyflow/tracker/test
          cat > app/src/main/java/com/moneyflow/tracker/test/TestFile.kt << 'EOF'
          package com.moneyflow.tracker.test

          class TestFile {
              fun testFunction(): String {
                  return "This is a test from workflow: ${{ inputs.task }}"
              }
          }
          EOF
          echo "âœ… Mock file created"
          cat app/src/main/java/com/moneyflow/tracker/test/TestFile.kt

      - name: Test - Create unique branch
        run: |
          git fetch origin master
          git checkout master
          git pull origin master

          RAND_ID=$(head /dev/urandom | tr -dc a-z0-9 | head -c4)
          BRANCH="test/$(date +%s)-${RAND_ID}-workflow-test"
          echo "branch=$BRANCH" >> $GITHUB_ENV

          git config user.name "Test Bot"
          git config user.email "test@moneyflow.app"

          while git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; do
            RAND_ID=$(head /dev/urandom | tr -dc a-z0-9 | head -c4)
            BRANCH="test/$(date +%s)-${RAND_ID}-workflow-test"
            echo "branch=$BRANCH" >> $GITHUB_ENV
          done

          git checkout -b "$BRANCH"
          echo "âœ… Branch created: $BRANCH"

      - name: Test - Commit changes
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "âŒ No changes to commit"
            echo "changes=false" >> $GITHUB_ENV
          else
            git commit -m "ğŸ§ª Test: ${{ inputs.task }}"
            echo "changes=true" >> $GITHUB_ENV
            echo "âœ… Changes committed"
          fi

      - name: Test - Ensure PR label exists
        if: env.changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LABEL="test-workflow"
          gh label list | grep -q "$LABEL" || gh label create "$LABEL" --description "Test PR generated by workflow" --color "00ff00"
          echo "âœ… Label ensured: $LABEL"

      - name: Test - Create PR body file
        if: env.changes == 'true'
        run: |
          PR_TITLE=$(python3 -c "import json; print(json.load(open('ai_output.json'))['pr_title'])")
          PR_DESC=$(python3 -c "import json; print(json.load(open('ai_output.json'))['pr_description'])")

          echo "## Test PR (No API Called)" > pr_body.md
          echo "" >> pr_body.md
          echo "$PR_DESC" >> pr_body.md
          echo "" >> pr_body.md
          echo "---" >> pr_body.md
          echo "" >> pr_body.md
          echo "**Task:** ${{ inputs.task }}" >> pr_body.md
          echo "**This is a TEST:** No AI API was called" >> pr_body.md
          echo "**No tokens consumed:** âœ…" >> pr_body.md
          echo "**Branch:** \`${{ env.branch }}\`" >> pr_body.md
          echo "âœ… PR body created"
          cat pr_body.md

      - name: Test - Push branch and create PR
        if: env.changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push origin ${{ env.branch }}

          PR_TITLE=$(python3 -c "import json; print(json.load(open('ai_output.json'))['pr_title'])")

          gh pr create \
            --title "ğŸ§ª TEST: $PR_TITLE" \
            --body-file pr_body.md \
            --base master \
            --head ${{ env.branch }} \
            --label "test-workflow"

          echo "âœ… TEST PR created successfully"

      - name: Cleanup temporary files
        if: env.changes == 'true'
        run: |
          rm -f pr_body.md ai_output.json
          echo "ğŸ§¹ Temporary files cleaned up"

      - name: Summary
        run: |
          echo "ğŸ‰ Workflow test completed!"
          if [ "${{ env.changes }}" == "true" ]; then
            echo "âœ… Test PR created - check Pull Requests tab"
          else
            echo "âŒ No changes to commit, no PR created"
          fi
