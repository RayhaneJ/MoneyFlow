name: Test AI Workflow

on:
  workflow_dispatch:
    inputs:
      task:
        description: 'Test task description'
        required: true
        default: 'Add a simple feature'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  test-ai-production:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout full repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Important pour avoir tout l'historique et Ã©viter "No commits between main and branch"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Test - Create mock AI response
        run: |
          echo "ðŸ§ª Creating MOCK AI response (no API call)"
          
          cat > ai_output.json << 'EOF'
          {
            "task": "${{ inputs.task }}",
            "files_created": ["app/src/main/java/com/moneyflow/tracker/test/TestFile.kt"],
            "files_modified": [],
            "pr_title": "Test: ${{ inputs.task }}",
            "pr_description": "This is a TEST PR generated without calling the AI API.\n\n- No tokens consumed\n- No API costs\n- Just testing the workflow",
            "breaking_changes": false,
            "requires_migration": false
          }
          EOF
          echo "âœ… Mock response created"

      - name: Test - Create mock code file
        run: |
          echo "ðŸ§ª Creating MOCK Kotlin file"
          mkdir -p app/src/main/java/com/moneyflow/tracker/test
          cat > app/src/main/java/com/moneyflow/tracker/test/TestFile.kt << 'EOF'
          package com.moneyflow.tracker.test

          /**
           * This is a TEST file created by the workflow
           * No AI was called, no tokens consumed
           */
          class TestFile {
              fun testFunction(): String {
                  return "This is a test from workflow: ${{ inputs.task }}"
              }
          }
          EOF
          echo "âœ… Mock file created"

      - name: Test - Create unique branch
        run: |
          # GÃ©nÃ©rer un nom unique avec timestamp + random
          RAND_ID=$(head /dev/urandom | tr -dc a-z0-9 | head -c4)
          BRANCH="test/$(date +%s)-${RAND_ID}-workflow-test"
          echo "branch=$BRANCH" >> $GITHUB_ENV

          git config user.name "Test Bot"
          git config user.email "test@moneyflow.app"

          # VÃ©rifier si la branche existe dÃ©jÃ  sur le remote
          while git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; do
            echo "âš  Branch $BRANCH already exists, generating a new one"
            RAND_ID=$(head /dev/urandom | tr -dc a-z0-9 | head -c4)
            BRANCH="test/$(date +%s)-${RAND_ID}-workflow-test"
            echo "branch=$BRANCH" >> $GITHUB_ENV
          done

          git checkout -b "$BRANCH"
          echo "âœ… Branch created: $BRANCH"

      - name: Test - Commit changes
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "âŒ No changes to commit"
            echo "changes=false" >> $GITHUB_ENV
          else
            git commit -m "ðŸ§ª Test: ${{ inputs.task }}"
            echo "changes=true" >> $GITHUB_ENV
            echo "âœ… Changes committed"

      - name: Test - Ensure PR label exists
        if: env.changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LABEL="test-workflow"
          # CrÃ©er le label si inexistant
          gh label list | grep -q "$LABEL" || gh label create "$LABEL" --description "Test PR generated by workflow" --color "00ff00"
          echo "âœ… Label ensured: $LABEL"

      - name: Test - Create PR body file
        if: env.changes == 'true'
        run: |
          echo "ðŸ§ª Creating PR body file"
          PR_TITLE=$(python3 -c "import json; print(json.load(open('ai_output.json'))['pr_title'])")
          PR_DESC=$(python3 -c "import json; print(json.load(open('ai_output.json'))['pr_description'])")

          echo "## Test PR (No API Called)" > pr_body.md
          echo "" >> pr_body.md
          echo "$PR_DESC" >> pr_body.md
          echo "" >> pr_body.md
          echo "---" >> pr_body.md
          echo "" >> pr_body.md
          echo "**Task:** ${{ inputs.task }}" >> pr_body.md
          echo "**This is a TEST:** No AI API was called" >> pr_body.md
          echo "**No tokens consumed:** âœ…" >> pr_body.md
          echo "**Branch:** \`${{ env.branch }}\`" >> pr_body.md
          echo "âœ… PR body created"
          cat pr_body.md

      - name: Test - Push branch and create PR
        if: env.changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ§ª Pushing branch and creating PR"
          git push origin ${{ env.branch }}

          PR_TITLE=$(python3 -c "import json; print(json.load(open('ai_output.json'))['pr_title'])")

          gh pr create \
            --title "ðŸ§ª TEST: $PR_TITLE" \
            --body-file pr_body.md \
            --base main \
            --head ${{ env.branch }} \
            --label "test-workflow"

          echo "âœ… TEST PR created successfully"

      - name: Cleanup temporary files (optional)
        if: env.changes == 'true'
        run: |
          rm -f pr_body.md ai_output.json
          echo "ðŸ§¹ Temporary files cleaned up"

      - name: Summary
        run: |
          echo "ðŸŽ‰ Workflow test completed!"
          echo ""
          echo "âœ… All steps executed successfully"
          echo "âœ… No API tokens consumed"
          echo "âœ… No costs incurred"
          echo "âœ… Workflow syntax is valid"
          if [ "${{ env.changes }}" == "true" ]; then
            echo "âœ… Test PR created - check the Pull Requests tab"
            echo "   You can merge or close it safely"
          fi
