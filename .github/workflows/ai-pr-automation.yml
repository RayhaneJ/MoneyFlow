name: AI PR Automation (Production Safe)

on:
  workflow_dispatch:
    inputs:
      task:
        description: 'What do you want the AI to implement?'
        required: true
        type: string
        default: 'Add dark mode support to Dashboard'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  ai-pr-generation:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout full repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install anthropic requests

      - name: Get task description
        id: get-task
        run: |
          TASK="${{ inputs.task }}"
          echo "task=$TASK" >> $GITHUB_OUTPUT
          echo "üìù Task: $TASK"

      - name: Generate code with AI
        id: ai-gen
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TASK: ${{ steps.get-task.outputs.task }}
        run: |
          python3 .github/scripts/ai_pr_generator.py "$TASK"

      - name: Create unique branch
        run: |
          git fetch origin master
          git checkout master
          git pull origin master

          RAND_ID=$(head /dev/urandom | tr -dc a-z0-9 | head -c4)
          BRANCH="ai/$(date +%s)-${RAND_ID}-workflow-task"
          echo "branch=$BRANCH" >> $GITHUB_ENV

          git config user.name "AI Bot"
          git config user.email "ai-bot@moneyflow.app"

          while git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; do
            RAND_ID=$(head /dev/urandom | tr -dc a-z0-9 | head -c4)
            BRANCH="ai/$(date +%s)-${RAND_ID}-workflow-task"
            echo "branch=$BRANCH" >> $GITHUB_ENV
          done

          git checkout -b "$BRANCH"
          echo "‚úÖ Branch created: $BRANCH"

      - name: Commit AI changes (safe)
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "‚ùå No changes to commit"
            echo "changes=false" >> $GITHUB_ENV
          else
            COMMIT_MSG_FILE=$(mktemp)
            cat > "$COMMIT_MSG_FILE" <<EOF
ü§ñ AI: ${{ steps.get-task.outputs.task }}
EOF
            git commit -F "$COMMIT_MSG_FILE"
            echo "changes=true" >> $GITHUB_ENV
            echo "‚úÖ Changes committed"
            rm -f "$COMMIT_MSG_FILE"

      - name: Ensure PR label exists
        if: env.changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LABEL="ai-generated"
          gh label list | grep -q "$LABEL" || gh label create "$LABEL" --description "AI generated PR" --color "00ff00"
          echo "‚úÖ Label ensured: $LABEL"

      - name: Create PR body file
        if: env.changes == 'true'
        run: |
          PR_TITLE=$(python3 -c "import json; print(json.load(open('ai_output.json'))['pr_title'])")
          PR_DESC=$(python3 -c "import json; print(json.load(open('ai_output.json'))['pr_description'])")

          echo "## AI Generated Changes" > pr_body.md
          echo "" >> pr_body.md
          echo "$PR_DESC" >> pr_body.md
          echo "" >> pr_body.md
          echo "---" >> pr_body.md
          echo "" >> pr_body.md
          echo "**Task:** ${{ steps.get-task.outputs.task }}" >> pr_body.md
          echo "**Generated by:** AI Bot" >> pr_body.md
          echo "**Branch:** \`${{ env.branch }}\`" >> pr_body.md
          echo "‚úÖ PR body created"

      - name: Push branch and create PR
        if: env.changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push origin ${{ env.branch }}

          PR_TITLE=$(python3 -c "import json; print(json.load(open('ai_output.json'))['pr_title'])")

          gh pr create \
            --title "ü§ñ $PR_TITLE" \
            --body-file pr_body.md \
            --base master \
            --head ${{ env.branch }} \
            --label "ai-generated"

          echo "‚úÖ AI PR created successfully"

      - name: Cleanup temporary files
        if: env.changes == 'true'
        run: |
          rm -f pr_body.md ai_output.json
          echo "üßπ Temporary files cleaned up"

      - name: Summary
        run: |
          echo "üéâ AI workflow completed!"
          if [ "${{ env.changes }}" == "true" ]; then
            echo "‚úÖ PR created: check Pull Requests tab"
          else
            echo "‚ùå No changes to commit, no PR created"
          fi
